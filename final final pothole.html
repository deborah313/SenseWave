<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SenseWave</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto Mono', monospace;
            background-color: #1a1a1a;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: #b3b3b3;
        }
        .container {
            max-width: 600px;
            width: 95%;
            background-color: #2a2a2a;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.2);
            text-align: center;
        }
        h1, h2 {
            color: #00ffcc;
            text-shadow: 0 0 5px #00ffcc;
        }
        .video-container {
            position: relative;
            width: 100%;
            padding-top: 75%; /* 4:3 Aspect Ratio */
            overflow: hidden;
            border-radius: 0.5rem;
            border: 2px solid #ff3399;
            box-shadow: 0 0 10px #ff3399;
            margin-bottom: 1.5rem;
        }
        #videoElement {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: scaleX(-1);
            object-fit: cover;
            filter: grayscale(80%) hue-rotate(250deg) saturate(150%);
        }
        #potholeCanvas {
            display: none;
        }
        .status-box {
            padding: 1rem;
            border-radius: 0.5rem;
            font-weight: 700;
            font-size: 1.25rem;
            margin-top: 1rem;
            transition: background-color 0.3s ease, color 0.3s ease;
            border: 2px solid;
            text-shadow: 0 0 3px;
        }
        .status-no-pothole {
            background-color: #3b3b3b;
            color: #00ffcc;
            border-color: #00ffcc;
            text-shadow: 0 0 5px #00ffcc;
        }
        .status-pothole-warning {
            background-color: #3b3b3b;
            color: #ff3399;
            border-color: #ff3399;
            text-shadow: 0 0 5px #ff3399;
        }
        .image-gallery img {
            width: 80px;
            height: 60px;
            object-fit: cover;
            border-radius: 0.25rem;
            cursor: pointer;
            border: 2px solid transparent;
            transition: border-color 0.3s ease;
            filter: grayscale(50%);
        }
        .image-gallery img:hover {
            border-color: #00ffcc;
            filter: none;
        }
        .solana-section {
            margin-top: 2rem;
            padding: 1.5rem;
            background-color: #232323;
            border-radius: 1rem;
            border: 1px dashed #3b3b3b;
        }
        .solana-button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 700;
            color: #1a1a1a;
            background-color: #00ffcc;
            transition: background-color 0.3s ease;
            cursor: pointer;
            display: inline-block;
            box-shadow: 0 0 10px #00ffcc;
        }
        .solana-button:hover:not(:disabled) {
            background-color: #00e6b3;
            box-shadow: 0 0 15px #00e6b3;
        }
        .solana-button:disabled {
            background-color: #555555;
            color: #b3b3b3;
            cursor: not-allowed;
            box-shadow: none;
        }
        .data-display {
            background-color: #111111;
            padding: 0.5rem;
            border-radius: 0.25rem;
            margin-top: 0.5rem;
            border: 1px solid #ff3399;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1 class="text-3xl font-bold mb-2">SenseWave</h1>
        <p class="text-xs mb-6 text-[#737373]">Citizen-driven infrastructure data stream. Unauthorized access will be flagged.</p>

        <div class="video-container">
            <video id="videoElement" autoplay playsinline></video>
            <canvas id="potholeCanvas"></canvas>
        </div>
        
        <div class="mt-4 mb-6">
            <h2 class="text-lg font-bold mb-2">Training Data Stream</h2>
            <p class="text-sm mb-4 text-[#737373]">Scanning known anomalies for pattern recognition:</p>
            <div class="image-gallery flex justify-center space-x-2">
                <img src="https://storage.googleapis.com/gweb-uniblog-publish-prod/images/Screenshot_2025-09-13_at_7.21.33_PM.width-1200.jpg" alt="Pothole Anomaly 1">
                <img src="https://storage.googleapis.com/gweb-uniblog-publish-prod/images/Screenshot_2025-09-13_at_7.21.44_PM.width-1200.jpg" alt="Pothole Anomaly 2">
                <img src="https://storage.googleapis.com/gweb-uniblog-publish-prod/images/Screenshot_2025-09-13_at_7.22.16_PM.width-1200.jpg" alt="Pothole Anomaly 3">
                <img src="https://storage.googleapis.com/gweb-uniblog-publish-prod/images/Screenshot_2025-09-13_at_7.21.59_PM.width-1200.png" alt="Pothole Anomaly 4">
                <img src="https://storage.googleapis.com/gweb-uniblog-publish-prod/images/Screenshot_2025-09-13_at_7.27.30_PM.width-1200.jpg" alt="Pothole Anomaly 5">
                <img src="https://storage.googleapis.com/gweb-uniblog-publish-prod/images/Screenshot_2025-09-13_at_7.27.46_PM.width-1200.jpg" alt="Pothole Anomaly 6">
            </div>
        </div>

        <div id="statusBox" class="status-box status-no-pothole">
            <span id="statusText">System Online. Awaiting anomalies.</span>
        </div>

        <div class="solana-section">
            <h2 class="text-xl font-bold mb-2">Decentralized Data Upload</h2>
            <p id="solanaStatus" class="text-sm text-[#737373] mb-4">Node Disconnected</p>
            <div class="data-display mb-4 text-xs text-left hidden" id="locationData">
                <p>Location: <span id="latLon"></span></p>
            </div>
            <button id="connectWalletBtn" class="solana-button">Connect Node</button>
            <button id="reportPotholeBtn" class="solana-button" disabled>Upload Anomaly to Grid</button>
        </div>
    </div>

    <script>
        const video = document.getElementById('videoElement');
        const canvas = document.getElementById('potholeCanvas');
        const context = canvas.getContext('2d');
        const statusBox = document.getElementById('statusBox');
        const statusText = document.getElementById('statusText');
        const solanaStatus = document.getElementById('solanaStatus');
        const connectWalletBtn = document.getElementById('connectWalletBtn');
        const reportPotholeBtn = document.getElementById('reportPotholeBtn');
        const locationDataDisplay = document.getElementById('locationData');
        const latLonText = document.getElementById('latLon');

        let stream = null;
        let detectionTimeoutId = null;
        let detectionIntervalId = null;
        let walletConnected = false;
        let currentLocation = null;

        // Function to get user's location
        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        currentLocation = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        };
                        latLonText.textContent = `${currentLocation.latitude.toFixed(4)}, ${currentLocation.longitude.toFixed(4)}`;
                        locationDataDisplay.classList.remove('hidden');
                        console.log("Location obtained: ", currentLocation);
                    },
                    (error) => {
                        console.error("Error getting location: ", error);
                        // Use a fallback location if access is denied
                        currentLocation = { latitude: 37.7749, longitude: -122.4194 }; // San Francisco, CA
                        latLonText.textContent = `SIMULATED: ${currentLocation.latitude.toFixed(4)}, ${currentLocation.longitude.toFixed(4)}`;
                        locationDataDisplay.classList.remove('hidden');
                    }
                );
            } else {
                latLonText.textContent = "Geolocation not supported.";
                // Use a fallback location if not supported
                currentLocation = { latitude: 37.7749, longitude: -122.4194 };
                locationDataDisplay.classList.remove('hidden');
            }
        }

        // Function to start the camera automatically
        async function startCamera() {
            try {
                // Request higher resolution video
                const constraints = {
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                
                video.onloadedmetadata = () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    if (!detectionIntervalId) {
                        detectionIntervalId = setInterval(detectPothole, 250);
                    }
                };
                getLocation(); // Get location on camera start
            } catch (err) {
                console.error("Error accessing the camera: ", err);
                statusText.textContent = "Error: Camera system offline.";
                statusBox.classList.remove('status-no-pothole');
                statusBox.classList.add('status-pothole-warning');
            }
        }

        function detectPothole() {
            if (!video.videoWidth || !video.videoHeight) return;

            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            const checkSize = 150;
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const imageData = context.getImageData(centerX - checkSize / 2, centerY - checkSize / 2, checkSize, checkSize);
            const pixels = imageData.data;

            let darkPoints = [];
            let highTexturePoints = [];
            let brightReflectionPoint = false;

            for (let y = 0; y < checkSize; y++) {
                for (let x = 0; x < checkSize; x++) {
                    const i = (y * checkSize + x) * 4;
                    const r = pixels[i];
                    const g = pixels[i + 1];
                    const b = pixels[i + 2];
                    const brightness = (r + g + b) / 3;
                    
                    let localTexture = 0;
                    if (x > 0) localTexture += Math.abs(brightness - ((pixels[i - 4] + pixels[i - 3] + pixels[i - 2]) / 3));
                    if (y > 0) localTexture += Math.abs(brightness - ((pixels[i - checkSize * 4] + pixels[i - checkSize * 4 + 1] + pixels[i - checkSize * 4 + 2]) / 3));

                    if (brightness < 70) {
                        darkPoints.push({ x, y });
                    }
                    if (localTexture > 20) {
                        highTexturePoints.push({ x, y });
                    }
                    if (brightness > 200) {
                        brightReflectionPoint = true;
                    }
                }
            }

            const darkPercentage = darkPoints.length / (checkSize * checkSize);
            const texturePercentage = highTexturePoints.length / (checkSize * checkSize);
            const highConfidence = darkPercentage > 0.1 && texturePercentage > 0.1;
            const veryHighConfidence = highConfidence && brightReflectionPoint;

            let finalConfidence = 0;
            if (veryHighConfidence) {
                finalConfidence = 100;
            } else if (highConfidence) {
                finalConfidence = 75;
            } else {
                finalConfidence = darkPercentage * 50;
            }
            
            const detectionThreshold = 25;
            if (finalConfidence > detectionThreshold && !detectionTimeoutId) {
                statusText.textContent = "⚠️ Anomaly Detected! Uploading data packet... ⚠️";
                statusBox.classList.remove('status-no-pothole');
                statusBox.classList.add('status-pothole-warning');
                
                solanaStatus.textContent = "Anomaly detected. Upload to Grid.";
                reportPotholeBtn.disabled = false;

                clearTimeout(detectionTimeoutId);
                detectionTimeoutId = setTimeout(() => {
                    statusText.textContent = "System Online. Awaiting anomalies.";
                    statusBox.classList.remove('status-pothole-warning');
                    statusBox.classList.add('status-no-pothole');
                    detectionTimeoutId = null;
                    if (walletConnected) {
                        solanaStatus.textContent = "Node Connected. Ready for data upload.";
                    }
                    reportPotholeBtn.disabled = true;
                }, 3000);
            }
        }

        function connectWallet() {
            connectWalletBtn.disabled = true;
            solanaStatus.textContent = "Connecting node...";
            
            setTimeout(() => {
                walletConnected = true;
                solanaStatus.textContent = "Node Connected.";
                connectWalletBtn.textContent = "Node Connected";
                connectWalletBtn.classList.add('bg-green-500');
                connectWalletBtn.style.boxShadow = '0 0 10px #32cd32';
                connectWalletBtn.disabled = false;
            }, 1500);
        }

        function reportPothole() {
            if (!walletConnected) {
                solanaStatus.textContent = "Please connect your node first.";
                return;
            }
            if (!currentLocation) {
                solanaStatus.textContent = "Awaiting location data.";
                return;
            }
            
            reportPotholeBtn.disabled = true;
            solanaStatus.textContent = "Uploading data packet to Grid...";
            
            const dataToUpload = {
                hazard: "pothole",
                location: currentLocation,
                timestamp: new Date().toISOString()
            };

            console.log("Simulating Solana transaction with data:", dataToUpload);

            setTimeout(() => {
                const transactionHash = `5H${Math.random().toString(36).substr(2, 10)}${Math.random().toString(36).substr(2, 10)}...`;
                solanaStatus.innerHTML = `Data packet uploaded to Grid. <br> Transaction Hash: <span class="text-[#00ffcc] text-sm break-all">${transactionHash}</span>`;
                reportPotholeBtn.disabled = false;
            }, 2000);
        }

        connectWalletBtn.addEventListener('click', connectWallet);
        reportPotholeBtn.addEventListener('click', reportPothole);

        window.onload = () => {
            startCamera();
            getLocation();
        };
    </script>
</body>
</html>
